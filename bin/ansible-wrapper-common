#!/usr/bin/env bash
export WC=$(pwd)
export A=${WC}/ansible
export DA=${WC}/.ansible
export OWC=${OWC:-${WC}}
export OA=${OWC}/ansible
export ODA=${OWC}/.ansible
export SCRIPT=$(basename "${0}")
export VENV_PATH="${VENV_PATH-${WC}/venv}"
export CONF_PREFIXES="/etc/ansible"
export MODULE_PREFIXES="/usr/share/ansible/plugins"

if [ -e "${VENV_PATH}/bin/activate" ]
then
    . "${VENV_PATH}/bin/activate"
else
    echo "virtualenv not found in ${VENV_PATH}" >&2
    exit 1
fi

for p in "${WC}" "${OWC}" "${ODA}" "${OA}" "${DA}" "${A}";do
    if [ -e "${p}" ];then
        CONF_PREFIXES="${p};${CONF_PREFIXES}"
        MODULE_PREFIXES="${p};${MODULE_PREFIXES}"
        for inventory in "${p}/inventories" "${p}/inventory";do
            if [ -e "${inventory}" ] && [[ -z ${ANSIBLE_HOSTS-} ]] ; then
                export ANSIBLE_HOSTS="${inventory}"
            fi
        done
        library="${p}/library"
        if [ -e "${library}" ];then
            if [[ -z ${ANSIBLE_LIBRARY-} ]]; then
                export ANSIBLE_LIBRARY="${library}"
            else
                export ANSIBLE_LIBRARY="${library}:${ANSIBLE_LIBRARY}"
            fi
        fi
        roles="${p}/roles"
        if [ -e "${roles}" ];then
            if [[ -z ${ANSIBLE_ROLES_PATH-} ]]; then
                export ANSIBLE_ROLES_PATH="${roles}"
            else
                export ANSIBLE_ROLES_PATH="${roles}:${ANSIBLE_ROLES_PATH}"
            fi
        fi
    fi
done

tmp="\
ANSIBLE_ACTION_PLUGINS:plugins/action:${MODULE_PREFIXES}
ANSIBLE_CACHE_PLUGINS:plugins/cache:${MODULE_PREFIXES}
ANSIBLE_CALLBACK_PLUGINS:plugins/callback:${MODULE_PREFIXES}
ANSIBLE_LOOKUP_PLUGINS:plugins/lookup:${MODULE_PREFIXES}
ANSIBLE_CONNECTION_PLUGINS:plugins/connection:${MODULE_PREFIXES}
ANSIBLE_INVENTORY_PLUGINS:plugins/inventory:${MODULE_PREFIXES}
ANSIBLE_FILTER_PLUGINS:plugins/filter:${MODULE_PREFIXES}
ANSIBLE_TEST_PLUGINS:plugins/test:${MODULE_PREFIXES}
ANSIBLE_STRATEGY_PLUGINS:plugins/strategy:${MODULE_PREFIXES}"

ANSIBLE_VARS="\
ANSIBLE_SSH_CONTROL_PATH:~/.assh_%%h.%%p-%%r
ANSIBLE_HOST_KEY_CHECKING:False
ANSIBLE_NOCOWS:False"

while read line;do
    default=$(echo "$line:"|cut -d: -f2)
    var=$(echo "$line:"|cut -d: -f1)
    eval 'val=$'"${var}"
    if [[ -n "${default}" ]] && [[ -z ${val} ]]; then
        if [[ -z ${val} ]];then
            eval ${var}'="'${default}'"'
        fi
    fi
    eval 'val=$'"${var}"
    if [[ -n ${val} ]]; then
        eval 'export '${var}'="'${val}'"'
    fi
done <<< "${ANSIBLE_VARS}"

if [[ -n ${ENV_DEBUG-} ]]; then
    env
    exit 1
fi
cd "${OWC}"
