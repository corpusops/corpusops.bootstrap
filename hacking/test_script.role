#!/usr/bin/env bash
set -x
W=$(pwd)
ROLEPATH=${ROLEPATH:-${1:-${W}}}
ROLENAME=$(basename $ROLEPATH)
COPS_ROOT=${COPS_ROOT:-/srv/corpusops/corpusops.bootstrap}
crole="${crole:-${COPS_ROOT}/bin/cops_apply_role -vvvv}"
cd "${COPS_ROOT}"
default_deps="corpusops.roles/localsettings_pkgmgr"
COPS_DEPS_ROLES="${COPS_DEPS_ROLES-${default_deps}}"
README="$ROLEPATH/README.md"
if [ -e "${README}" ];then
  for i in $(grep "cops roles dependencies:" "${README}" \
                |sed -re "s/.*cops roles dependencies:\s*//g"\
                |sed -re "s/(,| - )/ /g");do
    COPS_DEPS_ROLES="${COPS_DEPS_ROLES} ${i}"
  done
fi
for i in $COPS_DEPS_ROLES;do
    if ! ( $crole "roles/${i}/role.yml" );then
        echo "roles/${i}/role.yml failed"
        exit 4
    fi
done
ret=0
# try to readd a link to mimic the namespace
# when we have a rolepath without DOT (missing namespace)
lnk=""
if ( echo $ROLENAME | egrep -vq [.] ) && \
    [ -e "${ROLEPATH}/meta/main.yml" ];then
    NS=$( echo $(grep namespace: "${ROLEPATH}/meta/main.yml" \
                 | awk -F: '{print $2}'))
    lnk=${ROLEWD}/${NS}.${ROLENAME}
    if [ ! -e "${lnk}" ] && [ "x${NS}" != "x" ];then
        ln -fs "${ROLEPATH}" "${lnk}"
    else
        lnk=""
    fi
fi
if [[ -z ${ANSIBLE_ROLES_PATH-} ]]; then
    export ANSIBLE_ROLES_PATH="${ROLEWD}"
else
    export ANSIBLE_ROLES_PATH="${ROLEWD}:${ANSIBLE_ROLES_PATH}"
fi
for test_role_file in test.yml role.yml;do
    ftest_role_file="${ROLEPATH}/${test_role_file}"
    if [ -e "${ftest_role_file}" ]; then
        echo "Using ${ftest_role_file}" >&2
        ${crole} "${ftest_role_file}"
        ret=${?}
        if [ "x${ret}" != "x0" ];then
            echo "$ROLEPATH test failed"
        else
            echo "$ROLEPATH test success"
        fi
        break
    fi
done
if [ "x${lnk}" != "x" ] && [ -e "${lnk}" ];then
    rm -f "${lnk}"
fi
exit ${ret}
# vim:set ft=sh et:
