---
sudo: required
dist: trusty
env:
  matrix:
    - IMAGES="ubuntu:16.04_preprovision"
    - IMAGES="ubuntu:14.04_preprovision"
    - IMAGES="ubuntu:latest_preprovision"
language: python
python: "2.7"
before_install:
  - sudo apt-get update -qq
install:
  - |
    set -e;
    for i in $(echo "$IMAGES ubuntu:14.04"|xargs -n1|sort -u);do
     img="corpusops/$i"
     echo "docker pull $img"
     sudo docker pull "$img"
    done
  - |
    cat > copstest_test.sh << TEOF
    #!/usr/bin/env bash
    cd /srv/corpusops/corpusops.bootstrap
    if ! hacking/test_roles "$PWD";then
      echo "First test try failed, try to update code and retry test" >&2
      bin/install.sh -s
      hacking/test_roles "$PWD"
    fi
    TEOF
    #
  - cat copstest_test.sh
  - chmod +x copstest_*.sh
  - |
    set -e;
    docker=$(which docker)
    sudo docker run -d --name=copstestrunner \
       $( while read v; do echo " -v ${v}:${v}:ro";done < \
               <( ldd "${docker}"|awk '{print $3}'|egrep '^/'; )
       )\
       -v "${docker}:${docker}" \
       -v "/sys/fs/cgroup:/sys/fs/cgroup:ro" \
       -v "/var/lib/docker:/var/lib/docker" \
       -v "/var/run/docker:/var/run/docker" \
       -v "/var/run/docker.sock:/var/run/docker.sock" \
       -v "/:/HOST_ROOTFS" \
       -v "$PWD:$PWD" \
       -e IMAGES="$IMAGES" \
       "corpusops/ubuntu:14.04" bash -c 'while true;do sleep 65200;done'
script:
  - sudo docker exec copstestrunner bash -c "$PWD/copstest_test.sh"

